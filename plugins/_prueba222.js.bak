import fetch from 'node-fetch';

let handler = async (m, { conn, text, command }) => {
  try {
    // Obtener juego de la API
    const res = await fetch('https://api.vreden.my.id/api/tebakgambar');
    const data = await res.json();
    const image = data.result[0].image;
    const jawaban = data.result[0].jawaban;

    // Guardar respuesta por chat
    conn.tebakGambar = conn.tebakGambar || {};
    conn.tebakGambar[m.chat] = jawaban.toLowerCase();

    // Botones rápidos
    const buttons = [
      { buttonId: 'tebakgambar', buttonText: { displayText: '🔄 Otra imagen' }, type: 1 },
      { buttonId: '.hint', buttonText: { displayText: '💡 Pista' }, type: 1 }
    ];

    // Lista tipo Flow
    const sections = [
      {
        title: 'Opciones',
        rows: [
          { title: '🔄 Otra imagen', rowId: 'tebakgambar' },
          { title: '💡 Pista', rowId: 'hint' },
          { title: '❌ Rendirse', rowId: 'giveup' }
        ]
      }
    ];

    const listMessage = {
      text: `
╭━━━〔 🧩 TEBAK GAMBAR 〕━━⬣
┃ Intenta adivinar la respuesta de esta imagen.
┃ Envía tu respuesta o usa los botones/lista.
╰━━━━━━━━━━━━━━━━⬣
      `.trim(),
      footer: 'Rin Itoshi Bot',
      title: 'Tebak Gambar',
      buttonText: 'Opciones',
      sections
    };

    // Enviar imagen + botones + lista
    await conn.sendMessage(m.chat, {
      image: { url: image },
      caption: listMessage.text,
      footer: listMessage.footer,
      buttons,
      headerType: 4
    });

  } catch (err) {
    m.reply('❌ Ocurrió un error al obtener el juego.');
    console.error(err);
  }
};

handler.command = ['tebakgambar', 'tbg'];
export default handler;

// ------------------------
// Validación de respuestas
// ------------------------
let checkHandler = async (m, { conn, text }) => {
  if (!text) return;
  if (conn.tebakGambar && conn.tebakGambar[m.chat]) {
    const answer = conn.tebakGambar[m.chat];

    if (text.toLowerCase() === answer) {
      m.reply('🎉 ¡Correcto! Has adivinado.');
      delete conn.tebakGambar[m.chat];
    } else if (text.toLowerCase() === 'hint') {
      const hint = answer.split(' ')[0];
      m.reply(`💡 Pista: Empieza con "${hint}"`);
    } else if (text.toLowerCase() === 'giveup') {
      m.reply(`❌ La respuesta correcta era: ${answer}`);
      delete conn.tebakGambar[m.chat];
    } else {
      m.reply('❌ Incorrecto, intenta de nuevo.');
    }
  }
};

export { checkHandler };